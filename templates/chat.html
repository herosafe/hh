{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    在线用户
                </div>
                <ul class="list-group list-group-flush" id="online-users-list" style="max-height: 400px; overflow-y: auto;">
                    <li class="list-group-item text-muted text-center">
                        正在加载在线用户...
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header" id="chat-header">
                    请选择一个用户开始聊天
                </div>
                <div class="card-body chat-box" style="height: 400px; width: 99%; overflow-y: scroll;">
                    <div id="messages"></div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="请先选择一个用户开始聊天">
                        <button class="btn btn-primary" id="send-btn">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    let currentRoom = null;
    let currentUserId = parseInt("{{ current_user.id }}");

    // 处理开始聊天
    document.querySelectorAll('.start-chat').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const userId = this.dataset.userId;
            const userEmail = this.dataset.userEmail;
            
            // 创建或加入聊天室
            currentRoom = `room_${Math.min(currentUserId, userId)}_${Math.max(currentUserId, userId)}`;
            socket.emit('join', {room: currentRoom});
            
            // 更新UI
            document.getElementById('chat-header').textContent = `正在与 ${userEmail} 聊天`;
            document.getElementById('message-input').focus();
            document.getElementById('message-input').placeholder = "输入消息...";
            
            // 加载历史消息
            fetch(`/chat/history/${currentRoom}`)
                .then(response => response.json())
                .then(messages => {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `alert ${msg.sender_id == currentUserId ? 'alert-primary' : 'alert-secondary'} p-2 mb-2`;
                        messageElement.style.maxWidth = '70%';
                        messageElement.style.marginLeft = msg.sender_id == currentUserId ? 'auto' : '0';
                        messageElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>${msg.sender.email}</strong>
                                <small class="text-muted">${new Date(msg.timestamp).toLocaleTimeString()}</small>
                            </div>
                            <div>${msg.content}</div>
                        `;
                        messagesDiv.appendChild(messageElement);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
        });
    });

    // 处理回车键发送消息
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('send-btn').click();
        }
    });

    // 处理发送消息
    document.getElementById('send-btn').addEventListener('click', function() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (message && currentRoom) {
            socket.emit('message', {
                room: currentRoom,
                message: message
            });
            messageInput.value = '';
        }
    });

    // 接收消息
    socket.on('message', function(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = `alert ${data.sender == "{{ current_user.email }}" ? 'alert-primary' : 'alert-secondary'} p-2 mb-2`;
        messageElement.style.maxWidth = '70%';
        messageElement.style.marginLeft = data.sender == "{{ current_user.email }}" ? 'auto' : '0';
        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>${data.sender}</strong>
                <small class="text-muted">${data.timestamp}</small>
            </div>
            <div>${data.message}</div>
        `;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // 消息提醒
        if (Notification.permission === 'granted' && !document.hasFocus()) {
            const notification = new Notification('新消息', {
                body: `${data.sender}: ${data.message}`,
                icon: '/static/favicon.ico'
            });

            notification.onclick = function() {
                window.focus();
            };
        }
    });

    // 请求通知权限
    if (Notification.permission !== 'granted') {
        Notification.requestPermission();
    }

    // 更新在线用户列表
    function updateOnlineUsers(users) {
        const onlineUsersList = document.getElementById('online-users-list');
        onlineUsersList.innerHTML = '';

        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">在线</span>
                        <div>
                            <a href="#" class="start-chat text-decoration-none" data-user-id="${user.id}" data-user-email="${user.email}">
                                ${user.email}
                            </a>
                            ${user.factory || user.department ? `
                            <div class="text-muted small">
                                ${user.factory ? user.factory : ''}
                                ${user.factory && user.department ? ' - ' : ''}
                                ${user.department ? user.department : ''}
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            onlineUsersList.appendChild(li);
        });

        // 重新绑定点击事件
        document.querySelectorAll('.start-chat').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.dataset.userId;
                const userEmail = this.dataset.userEmail;
                
                // 创建或加入聊天室
                currentRoom = `room_${Math.min(currentUserId, userId)}_${Math.max(currentUserId, userId)}`;
                socket.emit('join', {room: currentRoom});
                
                // 更新UI
                document.getElementById('chat-header').textContent = `正在与 ${userEmail} 聊天`;
                document.getElementById('message-input').focus();
                document.getElementById('message-input').placeholder = "输入消息...";
                
                // 加载历史消息
                fetch(`/chat/history/${currentRoom}`)
                    .then(response => response.json())
                    .then(messages => {
                        const messagesDiv = document.getElementById('messages');
                        messagesDiv.innerHTML = '';
                        messages.forEach(msg => {
                            const messageElement = document.createElement('div');
                            messageElement.className = `alert ${msg.sender_id == currentUserId ? 'alert-primary' : 'alert-secondary'} p-2 mb-2`;
                            messageElement.style.maxWidth = '70%';
                            messageElement.style.marginLeft = msg.sender_id == currentUserId ? 'auto' : '0';
                            messageElement.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong>${msg.sender.email}</strong>
                                    <small class="text-muted">${new Date(msg.timestamp).toLocaleTimeString()}</small>
                                </div>
                                <div>${msg.content}</div>
                            `;
                            messagesDiv.appendChild(messageElement);
                        });
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    });
            });
        });
    }

    // 监听在线用户更新
    socket.on('update_online_users', function(users) {
        updateOnlineUsers(users);
    });

    // 初始加载在线用户
    socket.on('connect', function() {
        socket.emit('get_online_users');
    });

    socket.on('online_users', function(users) {
        updateOnlineUsers(users);
    });

    // 处理用户加入/离开
    socket.on('user_joined', function(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'alert alert-info';
        messageElement.textContent = `${data.user} 加入了聊天`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('user_left', function(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'alert alert-warning';
        messageElement.textContent = `${data.user} 离开了聊天`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>
{% endblock %}
