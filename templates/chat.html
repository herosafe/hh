{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    在线用户
                </div>
                <ul class="list-group list-group-flush" id="online-users-list" style="max-height: 400px; overflow-y: auto;">
                    <li class="list-group-item text-muted text-center">
                        正在加载在线用户...
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center" id="chat-header">
                    <span>全局聊天</span>
                    <button class="btn btn-sm btn-outline-secondary" id="toggle-chat-mode">
                        切换到私聊
                    </button>
                </div>
                <div class="card-body chat-box" style="height: 400px; width: 99%; overflow-y: scroll;">
                    <div id="messages"></div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="输入消息...">
                        <button class="btn btn-primary" id="send-btn">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    let currentRoom = null;
    let currentUserId = parseInt("{{ current_user.id }}");
    let isPrivateChat = false;

    // 切换聊天模式
    document.getElementById('toggle-chat-mode').addEventListener('click', function() {
        isPrivateChat = !isPrivateChat;
        currentRoom = null;
        document.getElementById('chat-header').children[0].textContent = isPrivateChat ? '私聊模式' : '全局聊天';
        this.textContent = isPrivateChat ? '切换到全局' : '切换到私聊';
        document.getElementById('message-input').placeholder = isPrivateChat ? '请选择一个用户开始私聊' : '输入消息...';
    });

    // 处理开始私聊
    function startPrivateChat(userId, userEmail) {
        if (!isPrivateChat) return;
        
        currentRoom = `room_${Math.min(currentUserId, userId)}_${Math.max(currentUserId, userId)}`;
        socket.emit('join', {room: currentRoom});
        
        document.getElementById('chat-header').children[0].textContent = `正在与 ${userEmail} 私聊`;
        document.getElementById('message-input').focus();
    }

    // 处理发送消息
    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (message) {
            if (isPrivateChat && !currentRoom) {
                alert('请先选择一个用户开始私聊');
                return;
            }

            socket.emit('message', {
                room: isPrivateChat ? currentRoom : 'global_chat',
                message: message,
                is_private: isPrivateChat
            });
            messageInput.value = '';
        }
    }

    // 点击发送按钮
    document.getElementById('send-btn').addEventListener('click', sendMessage);

    // 回车键发送消息
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // 阻止默认行为（换行）
            sendMessage();
        }
    });

    // 接收消息
    socket.on('message', function(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        
        // 设置消息样式
        let alertClass = 'alert-secondary';
        let align = '0';
        
        if (data.sender == "{{ current_user.email }}") {
            alertClass = data.is_private ? 'alert-info' : 'alert-primary';
            align = 'auto';
        } else {
            alertClass = data.is_private ? 'alert-warning' : 'alert-secondary';
        }
        
        messageElement.className = `alert ${alertClass} p-2 mb-2`;
        messageElement.style.maxWidth = '70%';
        messageElement.style.marginLeft = align;
        
        // 添加私聊标识
        const privateLabel = data.is_private ? '<span class="badge bg-dark me-2">私聊</span>' : '';
        
        // 格式化时间
        const timestamp = new Date(data.timestamp);
        const formattedTime = timestamp.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                    ${privateLabel}
                    <strong>${data.sender}</strong>
                </div>
                <small class="text-muted">${formattedTime}</small>
            </div>
            <div>${data.message}</div>
        `;
        
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // 自动滚动到底部
        messagesDiv.scrollTo({
            top: messagesDiv.scrollHeight,
            behavior: 'smooth'
        });

        // 消息提醒
        if (Notification.permission === 'granted' && !document.hasFocus()) {
            const notification = new Notification('新消息', {
                body: `${data.sender}: ${data.message}`,
                icon: '/static/favicon.ico'
            });

            notification.onclick = function() {
                window.focus();
            };
        }
    });

    // 更新在线用户列表
    function updateOnlineUsers(users) {
        const onlineUsersList = document.getElementById('online-users-list');
        onlineUsersList.innerHTML = '';

        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">在线</span>
                        <div>
                            <a href="#" class="start-chat text-decoration-none" data-user-id="${user.id}" data-user-email="${user.email}">
                                ${user.email}
                            </a>
                            ${user.factory || user.department ? `
                            <div class="text-muted small">
                                ${user.factory ? user.factory : ''}
                                ${user.factory && user.department ? ' - ' : ''}
                                ${user.department ? user.department : ''}
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            onlineUsersList.appendChild(li);
        });

        // 重新绑定点击事件
        document.querySelectorAll('.start-chat').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.dataset.userId;
                const userEmail = this.dataset.userEmail;
                startPrivateChat(userId, userEmail);
            });
        });
    }

    // 监听在线用户更新
    socket.on('update_online_users', function(users) {
        updateOnlineUsers(users);
    });

    // 初始加载在线用户
    socket.on('connect', function() {
        socket.emit('get_online_users');
    });

    socket.on('online_users', function(users) {
        updateOnlineUsers(users);
    });

    // 请求通知权限
    if (Notification.permission !== 'granted') {
        Notification.requestPermission();
    }
</script>
{% endblock %}
